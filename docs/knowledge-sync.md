# Knowledge Data Synchronization

This document describes the knowledge data synchronization system between the bigdata collection system, excelapp-rails admin panel, and the excelapp Next.js RAG system.

## System Overview

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   BigData       │    │ ExcelApp Rails  │    │ ExcelApp Next   │
│   Collection    │───▶│ Admin Panel     │───▶│ RAG System      │
│                 │    │                 │    │                 │
│ • Reddit API    │    │ • Data Storage  │    │ • Vector DB     │
│ • Stack Overflow│    │ • Quality Score │    │ • Embeddings    │
│ • Data Export   │    │ • Management    │    │ • Search        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Data Flow

### 1. Data Collection (BigData → Rails)
- BigData system collects Reddit and Stack Overflow Q&A data
- Exports data in JSONL format to shared directory
- Rails admin panel syncs data using `RedditDataSyncService`

### 2. Data Management (Rails Admin)
- Quality scoring and categorization
- Manual data curation and verification
- Bulk import/export functionality
- Real-time statistics and monitoring

### 3. Data Import (Rails → Next.js)
- Automated synchronization using `sync-knowledge-data.ts` script
- Vector embedding generation for semantic search
- RAG system integration with source metadata

## Usage

### Running Data Synchronization

#### From ExcelApp Rails (Data Collection)
```bash
# Sync Reddit data from bigdata system
cd /Users/kevin/excelapp-rails
bin/rails console
> RedditDataSyncService.perform_sync

# Bulk import from JSONL file
# Via admin panel: /admin/knowledge_base/reddit
# Upload JSONL file generated by bigdata system
```

#### From ExcelApp Next.js (RAG Import)
```bash
# Full synchronization
cd /Users/kevin/excelapp
npm run sync-knowledge

# With custom parameters
npm run sync-knowledge -- --batch-size 100 --quality-threshold 7.0

# Help and options
npm run sync-knowledge:help
```

### API Endpoints

#### Rails API (Data Export)
```bash
# Get all knowledge threads
GET /api/v1/knowledge_threads
Authorization: Bearer <API_KEY>

# Get statistics
GET /api/v1/knowledge_threads/stats

# Export data
GET /api/v1/knowledge_threads/export?format=jsonl
```

#### Next.js API (RAG Integration)
```bash
# Search knowledge base
POST /api/ai/chat
{
  "message": "VLOOKUP 오류 해결 방법",
  "useKnowledgeBase": true
}
```

## Configuration

### Environment Variables

#### ExcelApp Rails
```bash
# .env
BIGDATA_OUTPUT_PATH=/Users/kevin/bigdata/data/output
EXCELAPP_API_KEY=your_secure_api_key
OPENROUTER_API_KEY=your_openrouter_key
```

#### ExcelApp Next.js
```bash
# .env.local
OPENROUTER_API_KEY=your_openrouter_key
RAILS_API_URL=http://localhost:3001
```

### BigData Integration
```bash
# BigData system configuration
REDDIT_OUTPUT_PATH=/Users/kevin/bigdata/data/output
REDDIT_EXPORT_FORMAT=jsonl
QUALITY_THRESHOLD=5.0
```

## Data Format

### Reddit Thread Format (JSONL)
```json
{
  "metadata": {
    "submission_id": "1m2cvm2",
    "solution_comment_id": "abc123",
    "source_url": "https://reddit.com/r/excel/comments/1m2cvm2/",
    "collection_timestamp": "2024-01-15T10:30:00Z"
  },
  "question": {
    "title": "VLOOKUP 함수에서 #N/A 오류 해결 방법",
    "body": "VLOOKUP을 사용하는데 계속 #N/A 오류가 발생합니다...",
    "score": 25,
    "tags": ["vlookup", "formula", "error"],
    "link_flair_text": "solved"
  },
  "answer": {
    "body_markdown": "#N/A 오류는 주로 다음과 같은 경우에 발생합니다...",
    "score": 42
  },
  "quality_metrics": {
    "overall_score": 8.2,
    "reddit_features": {
      "op_confirmed": true,
      "solution_type": "formula_solution"
    }
  }
}
```

### RAG System Format
```typescript
interface RAGResponse {
  answer: string
  confidence: number
  sources: {
    id: string
    title: string
    category: string
    quality: number
    similarity: number
    source: 'stackoverflow' | 'reddit' | 'manual'
    sourceMetadata?: {
      platform?: string
      votes?: number
      isAccepted?: boolean
      opConfirmed?: boolean
      threadUrl?: string
    }
  }[]
}
```

## Quality Scoring

### Automatic Quality Factors
- **Content Length**: Longer, detailed answers score higher
- **Community Validation**: OP confirmation (Reddit) or accepted answers (Stack Overflow)
- **Vote Score**: Upvotes indicate community approval
- **Category Relevance**: Excel-specific content gets bonus points

### Quality Tiers
- **Excellent (9.0+)**: High-quality, verified solutions
- **Good (7.5-8.9)**: Solid answers with good community feedback
- **Fair (6.5-7.4)**: Acceptable quality, may need verification
- **Poor (<6.5)**: Low quality, excluded from RAG by default

## Monitoring

### Admin Dashboard
- Real-time sync status
- Quality distribution charts
- Source-specific statistics
- Error tracking and alerts

### Logs
```bash
# Rails logs
tail -f log/development.log | grep "Reddit"

# Next.js logs
npm run sync-knowledge 2>&1 | tee sync.log
```

## Troubleshooting

### Common Issues

#### Sync Failures
```bash
# Check bigdata output directory
ls -la /Users/kevin/bigdata/data/output/*reddit*.jsonl

# Verify API connectivity
curl -H "Authorization: Bearer $EXCELAPP_API_KEY" \
     http://localhost:3001/api/v1/knowledge_threads/stats
```

#### Embedding Errors
```bash
# Check OpenRouter API key
echo $OPENROUTER_API_KEY

# Test embedding generation
npm run sync-knowledge -- --batch-size 1
```

#### Data Quality Issues
```bash
# Review quality distribution
curl http://localhost:3001/api/v1/knowledge_threads/stats | jq '.quality_distribution'

# Manual quality check
cd /Users/kevin/excelapp-rails
bin/rails console
> KnowledgeThread.where('quality_score < 5').count
```

## Performance

### Optimization Settings
- **Batch Size**: 50-100 threads per batch (memory vs speed trade-off)
- **Quality Threshold**: 5.0+ for production, 3.0+ for development
- **Embedding Model**: `text-embedding-3-small` for speed, `text-embedding-3-large` for accuracy

### Scaling Considerations
- Use streaming exports for large datasets (>10k threads)
- Implement incremental sync based on `updated_at` timestamps
- Consider Redis caching for frequently accessed statistics

This synchronization system ensures high-quality knowledge data flows seamlessly from collection to user-facing search, maintaining data integrity and search relevance throughout the pipeline.